<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pearl.mapper.GalleryMapper">

	<select id="list" resultType="com.pearl.domain.GalleryVO">
		select b.*, m.memname from
		<choose>
		<when test="allign != null and allign != ''">
					(select row_number() over(order by emo desc) rn, b.*,e.emo from board b 
					join
					(select boardnum, count(
			<choose>
				<when test="'favorite'.equals(allign)">
					emoexpress
				</when>
				<when test="'like'.equals(allign)">
					case emoexpress when 'a' then 1 end
				</when>
				<when test="'sad'.equals(allign)">
					case emoexpress when 'b' then 1 end
				</when>
				<when test="'angry'.equals(allign)">
					case emoexpress when 'c' then 1 end
				</when>
				<when test="'happy'.equals(allign)">
					case emoexpress when 'd' then 1 end
				</when>
			</choose>
					) emo from board left 
						join emotion using(boardnum) group by boardnum) e 
					on(e.boardnum=b.boardnum) where b.boardtype = 'c')
		</when>
		<otherwise>
			(select /*+INDEX_desc(b board_pk)*/ rownum rn, b.* 
			from Board b
			where boardnum > 0 and boardtype='c' )
		 </otherwise>
		 </choose>
	<![CDATA[  
			 b, member m 
    where b.memnum=m.memnum and rn <=#{pagiInfo.lastRecordIndex} 
    and rn > #{pagiInfo.firstRecordIndex}
	]]>
		<include refid="sql-search.search" />
	</select>
	
	
	
	<select id="selectTotalCount" resultType="int">
		select count(*) from board join member using(memnum) where boardtype='c'
		<include refid="sql-search.search" />
	</select>
	
	<select id="read" resultType="com.pearl.domain.BoardVO">
		select * from Board 
		where boardnum = #{boardNum}
	</select>
	
	<select id="readWriter" resultType="com.pearl.domain.MemberVO">
		select * from member 
		where memnum = #{memNum}
	</select>
	
	<insert id="insert">
		insert into Board(boardNum, memNum, boardTitle, boardContent, boardDate, boardType)
		values(BOARD_SEQ.nextval, 1, #{boardTitle}, #{boardContent}, sysdate, 'c')
	</insert>
	
	<delete id="delete">
		delete Board 
		where boardNum=#{boardNum}
	</delete>
	
	<update id="update">
		update Board  
		set boardTitle=#{boardTitle}, boardContent=#{boardContent}  
		where boardNum = #{boardNum}
	</update>
	
	<insert id="emotionInsert">
		insert into emotion values(emotion_seq.nextval, #{boardNum}, #{memNum},#{emoExpress})
	</insert>
	
	<select id="getEmo" resultType="com.pearl.domain.EmotionVO">
		select * from emotion where boardNum=#{boardNum} and memNum=#{memNum}
	</select>
	
	<update id="updateEmo">
		update emotion set emoExpress=#{emoExpress} where boardNum=#{boardNum} and memNum=#{memNum}
	</update>
	
</mapper>
